<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’¢é“ä¾ ç²’å­åœ£è¯æ ‘</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        video { display: none; }
        canvas { position: absolute; width: 100%; height: 100%; transform: scaleX(-1); }
        #gallery-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0, 0, 0, 0.6); display: flex; align-items: center;
            overflow-x: auto; padding: 0 10px; box-sizing: border-box; z-index: 100;
        }
        .gallery-item {
            height: 80px; width: 80px; object-fit: cover; margin-right: 10px;
            border-radius: 8px; cursor: pointer; border: 3px solid transparent;
            transition: all 0.2s; flex-shrink: 0;
        }
        .gallery-item:hover { transform: scale(1.05); }
        .gallery-item.selected { border-color: #ffd700; }
        #status-bar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%) scaleX(-1);
            color: #00ffff; background: rgba(0,0,0,0.7); padding: 10px 25px;
            border-radius: 20px; pointer-events: none; z-index: 50; 
            font-weight: bold; letter-spacing: 1px; border: 1px solid #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }
    </style>
</head>
<body>

    <div id="status-bar">ç­‰å¾…æ‰‹åŠ¿æŒ‡ä»¤...</div>

    <video id="input_video"></video>
    <canvas id="output_canvas"></canvas>

    <div id="gallery-container">
        <div style="color:white;width:100%;text-align:center;">æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
    </div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const ctx = canvasElement.getContext('2d');
    const statusEl = document.getElementById('status-bar');

    // --- å…¨å±€çŠ¶æ€ ---
    let MODE = 'TREE'; // 'TREE' (æ ‘) | 'EXPLODE' (ç²’å­äº‘)
    let INTERACTION = 'NONE'; // 'NONE' | 'PINCHING'
    
    // å›¾ç‰‡çŠ¶æ€
    let imgObj = new Image(); imgObj.src = "";
    let imgState = { x: 0.5, y: 0.5, scale: 0, opacity: 0 }; // åˆå§‹ opacity 0 (éšè—)

    // --- âœ‹ æ‰‹åŠ¿æ£€æµ‹é€»è¾‘ ---
    function detectGesture(landmarks) {
        // å…³é”®ç‚¹ç´¢å¼•: 0(æ‰‹è…•), 8(é£ŸæŒ‡å°–), 12(ä¸­æŒ‡å°–), 16(æ— åæŒ‡å°–), 20(å°æŒ‡å°–)
        // ç®€å•ç®—æ³•ï¼šå¦‚æœæŒ‡å°–éƒ½å¾ˆé è¿‘æ‰‹è…•(0ç‚¹)ï¼Œå°±æ˜¯æ¡æ‹³
        
        const wrist = landmarks[0];
        const tips = [8, 12, 16, 20];
        let foldedFingers = 0;

        tips.forEach(idx => {
            const tip = landmarks[idx];
            // è®¡ç®—æŒ‡å°–åˆ°æ‰‹è…•çš„è·ç¦»
            const dist = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);
            // å½’ä¸€åŒ–è·ç¦»åˆ¤æ–­ (æ ¹æ®æ‰‹æŒå¤§å°è°ƒæ•´é˜ˆå€¼ï¼Œé€šå¸¸<0.3ç®—æŠ˜å )
            if (dist < 0.35) foldedFingers++; 
        });

        // æ‹‡æŒ‡(4)å’Œé£ŸæŒ‡(8)çš„è·ç¦»ç”¨äºåˆ¤æ–­æåˆ
        const pinchDist = Math.hypot(landmarks[4].x - landmarks[8].x, landmarks[4].y - landmarks[8].y);
        const isPinch = pinchDist < 0.05;

        // çŠ¶æ€åˆ¤å®šä¼˜å…ˆçº§
        if (isPinch) return 'PINCH';
        if (foldedFingers >= 3) return 'FIST'; // æ¡æ‹³
        if (foldedFingers <= 1) return 'OPEN'; // å¼ å¼€
        return 'UNKNOWN';
    }

    // --- âœ¨ ç²’å­ç³»ç»Ÿ ---
    class Particle {
        constructor() {
            this.x = Math.random() * canvasElement.width;
            this.y = Math.random() * canvasElement.height;
            this.tx = this.x; // ç›®æ ‡ä½ç½® X
            this.ty = this.y; // ç›®æ ‡ä½ç½® Y
            
            this.color = `hsl(${Math.random()*40 + 40}, 100%, 70%)`; // é‡‘è‰²/é»„è‰²ç³»
            this.baseSize = Math.random() * 3 + 1;
            
            // æ ‘å½¢æ€çš„å‚æ•°
            this.treeY = Math.random(); // 0-1 (æ ‘çš„é«˜åº¦ä½ç½®)
            this.treeAngle = Math.random() * Math.PI * 2;
        }

        update(centerX, centerY, treeHeight) {
            // 1. è®¡ç®—ç›®æ ‡ä½ç½®
            if (MODE === 'TREE') {
                // æ ‘å½¢æ€ï¼šåœ†é”¥èºæ—‹
                const maxRadius = treeHeight * 0.4 * (1 - this.treeY);
                this.tx = centerX + Math.cos(this.treeAngle) * maxRadius;
                this.ty = centerY + (this.treeY - 0.5) * -treeHeight;
                
                // è®©ç²’å­åœ¨æ ‘ä¸Šæ—‹è½¬
                this.treeAngle += 0.02;
                this.color = '#FFD700'; // æ ‘æ˜¯é‡‘è‰²çš„
            } else if (MODE === 'EXPLODE') {
                // çˆ†ç‚¸å½¢æ€ï¼šå‘å››å‘¨æ‰©æ•£ + éšæœºæ¼‚æµ®
                // åˆ©ç”¨ treeAngle åšäº›éšæœºè¿åŠ¨
                this.treeAngle += 0.005;
                const radius = treeHeight * 1.5; // æ‰©æ•£åŠå¾„æ›´å¤§
                // ç®€å•çš„å™ªç‚¹æ¼‚æµ®ç®—æ³•
                this.tx = centerX + Math.cos(this.treeAngle * 3 + this.treeY * 10) * radius * (this.treeY + 0.2);
                this.ty = centerY + Math.sin(this.treeAngle * 2 + this.treeY * 10) * radius * (this.treeY + 0.2);
                
                // çˆ†ç‚¸æ—¶å˜å½©è‰²
                this.color = `hsl(${this.treeY * 360}, 80%, 60%)`;
            }

            // 2. ç¼“åŠ¨åŠ¨ç”» (Ease out) - è®©ç²’å­é£è¿‡å»
            this.x += (this.tx - this.x) * 0.08;
            this.y += (this.ty - this.y) * 0.08;
        }

        draw(ctx) {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.baseSize, 0, Math.PI * 2);
            ctx.fillStyle = this.color;
            ctx.shadowColor = this.color;
            ctx.shadowBlur = 10;
            ctx.fill();
        }
    }

    // åˆå§‹åŒ–ç²’å­æ± 
    const particles = [];
    for(let i=0; i<600; i++) particles.push(new Particle());

    // --- ğŸ¥ ä¸»æ¸²æŸ“å¾ªç¯ ---
    function onResults(results) {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
        
        // 1. ç»˜åˆ¶èƒŒæ™¯
        ctx.save();
        ctx.filter = 'brightness(0.5) contrast(1.2)'; // å‹æš—èƒŒæ™¯è®©ç²’å­æ›´äº®
        ctx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        ctx.filter = 'none';
        ctx.globalCompositeOperation = 'lighter'; // å åŠ å‘å…‰æ¨¡å¼

        let handCenter = { x: canvasElement.width/2, y: canvasElement.height/2 };
        let gesture = 'UNKNOWN';

        // 2. å¤„ç†æ‰‹åŠ¿ & çŠ¶æ€æœº
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            gesture = detectGesture(landmarks);
            
            // æ›´æ–°æ‰‹å¿ƒåæ ‡ (ç”¨ä¸­æŒ‡æ ¹éƒ¨ 9 å’Œ æ‰‹è…• 0 çš„ä¸­é—´ç‚¹)
            handCenter.x = (landmarks[9].x + landmarks[0].x) / 2 * canvasElement.width;
            handCenter.y = (landmarks[9].y + landmarks[0].y) / 2 * canvasElement.height;

            // --- çŠ¶æ€åˆ‡æ¢é€»è¾‘ ---
            if (gesture === 'FIST') {
                MODE = 'TREE';
                statusEl.innerText = "âœŠ èšåˆï¼šåœ£è¯æ ‘æ¨¡å¼";
                statusEl.style.color = "#FFD700";
                // æ¡æ‹³æ—¶ï¼Œç…§ç‰‡éšè—
                imgState.opacity *= 0.8; 
            } else if (gesture === 'OPEN') {
                MODE = 'EXPLODE';
                statusEl.innerText = "ğŸ– æ‰©æ•£ï¼šç²’å­äº‘æ¨¡å¼";
                statusEl.style.color = "#00ffff";
                // å¼ å¼€æ‰‹æ—¶ï¼Œç…§ç‰‡ä¹Ÿéšè—(æˆ–è€…å˜å°)ï¼Œç­‰å¾…æŠ“å–
                imgState.opacity *= 0.8;
            } else if (gesture === 'PINCH') {
                // æåˆï¼šä¸æ”¹å˜ç²’å­æ¨¡å¼ï¼Œåªæ”¹å˜ç…§ç‰‡çŠ¶æ€
                statusEl.innerText = "ğŸ‘Œ æŠ“å–ï¼šç…§ç‰‡æ”¾å¤§";
                statusEl.style.color = "#ff00ff";
                
                // æåˆé€»è¾‘ï¼šç§»åŠ¨å¹¶æ˜¾ç¤ºç…§ç‰‡
                const thumb = landmarks[4];
                const index = landmarks[8];
                const pinchX = (thumb.x + index.x) / 2 * canvasElement.width;
                const pinchY = (thumb.y + index.y) / 2 * canvasElement.height;
                
                // ç…§ç‰‡è·Ÿéšæåˆç‚¹
                imgState.x += (pinchX - imgState.x) * 0.1; // ç¼“åŠ¨è·Ÿéš
                imgState.y += (pinchY - imgState.y) * 0.1;
                imgState.opacity += (1 - imgState.opacity) * 0.1; // æ¸æ˜¾
                imgState.scale += (1 - imgState.scale) * 0.1;     // å˜å¤§åˆ° 1.0
            }
        } else {
            // æ²¡æœ‰æ‰‹çš„æ—¶å€™ï¼Œé»˜è®¤æ˜¾ç¤ºæ ‘
            MODE = 'TREE';
            statusEl.innerText = "ç­‰å¾…æ‰‹åŠ¿...";
            statusEl.style.color = "#fff";
            imgState.opacity *= 0.9; // æ²¡äººå°±éšè—ç…§ç‰‡
        }

        // 3. æ›´æ–°å¹¶ç»˜åˆ¶ç²’å­
        // ç²’å­ä¸­å¿ƒè·Ÿéšæ‰‹å¿ƒ (å¦‚æœæ²¡æœ‰æ‰‹ï¼Œå°±å±…ä¸­)
        particles.forEach(p => {
            p.update(handCenter.x, handCenter.y, canvasElement.height * 0.5);
            p.draw(ctx);
        });

        // 4. ç»˜åˆ¶ç…§ç‰‡ (å…¨æ¯æŠ•å½±é£æ ¼)
        if (imgObj.src && imgObj.complete && imgState.opacity > 0.01) {
            ctx.globalCompositeOperation = 'source-over'; // æ­£å¸¸ç»˜åˆ¶ç…§ç‰‡
            ctx.save();
            ctx.globalAlpha = imgState.opacity;
            
            const aspectRatio = imgObj.naturalWidth / imgObj.naturalHeight || 1;
            // åŸºç¡€å®½åº¦ 300px * scale
            const drawW = 300 * Math.max(0.5, imgState.scale); 
            const drawH = drawW / aspectRatio;
            const drawX = imgState.x - drawW/2;
            const drawY = imgState.y - drawH/2;

            // ç»˜åˆ¶ç…§ç‰‡
            ctx.drawImage(imgObj, drawX, drawY, drawW, drawH);
            
            // ç§‘æŠ€æ„Ÿè¾¹æ¡†
            ctx.strokeStyle = "cyan";
            ctx.lineWidth = 3;
            ctx.shadowColor = "cyan";
            ctx.shadowBlur = 20;
            ctx.strokeRect(drawX, drawY, drawW, drawH);
            
            // è¾¹è§’è£…é¥°
            ctx.fillStyle = "cyan";
            const corner = 10;
            ctx.fillRect(drawX - 2, drawY - 2, corner, corner);
            ctx.fillRect(drawX + drawW - corner + 2, drawY - 2, corner, corner);
            ctx.fillRect(drawX - 2, drawY + drawH - corner + 2, corner, corner);
            ctx.fillRect(drawX + drawW - corner + 2, drawY + drawH - corner + 2, corner, corner);

            ctx.restore();
        }

        ctx.restore();
    }

    // --- MediaPipe åˆå§‹åŒ– ---
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);
    const camera = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 1280, height: 720 });
    camera.start();

    // --- åŠ è½½ç´ æ ---
    async function loadGallery() {
        const container = document.getElementById('gallery-container');
        try {
            const res = await fetch('/api/images');
            const images = await res.json();
            container.innerHTML = '';
            
            if(images.length === 0) { container.innerHTML = '<div style="color:white;margin:auto">Bucketä¸ºç©º</div>'; return; }

            images.forEach((data, idx) => {
                const el = document.createElement('img');
                el.src = data.url;
                el.className = 'gallery-item';
                el.onclick = () => {
                    document.querySelectorAll('.gallery-item').forEach(e=>e.classList.remove('selected'));
                    el.classList.add('selected');
                    // åŠ ä¸Šæ—¶é—´æˆ³é˜²ç¼“å­˜
                    imgObj.crossOrigin = "Anonymous";
                    imgObj.src = data.url + "?t=" + Date.now();
                };
                if(idx===0) el.click();
                container.appendChild(el);
            });
        } catch(e) { console.error(e); container.innerHTML = '<div style="color:red;margin:auto">åŠ è½½å¤±è´¥</div>'; }
    }
    loadGallery();

</script>
</body>
</html>