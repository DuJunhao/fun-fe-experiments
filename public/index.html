<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 素材选择器</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; }
        
        /* 模拟 AR 画布 */
        canvas { 
            display: block; 
            width: 100vw; 
            height: 100vh; 
        }

        /* 底部素材库样式 */
        #gallery-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            overflow-x: auto; /* 允许横向滚动 */
            padding: 0 10px;
            box-sizing: border-box;
            z-index: 100;
        }

        .gallery-item {
            height: 80px;
            width: 80px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            flex-shrink: 0; /* 防止图片被挤压 */
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        /* 选中态高亮 */
        .gallery-item.selected {
            border-color: #ffd700; /* 金色边框 */
        }
        
        #loading-text {
            color: white;
            font-size: 14px;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body>

    <canvas id="output_canvas"></canvas>

    <div id="gallery-container">
        <div id="loading-text">正在加载云端素材...</div>
    </div>

    <script>
        // --- 1. 简单的 Canvas 渲染逻辑 (用来模拟你的 AR 效果) ---
        const canvas = document.getElementById('output_canvas');
        const ctx = canvas.getContext('2d');
        
        // 设置画布大小
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // 当前选中的 AR 贴图对象
        let currentAsset = new Image();
        // 默认给个空图或者加载提示图
        currentAsset.src = ''; 
        
        // 简单的绘制循环 (你可以替换成你的 MediaPipe 逻辑)
        function drawLoop() {
            // 清空画布
            ctx.fillStyle = "#333";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 绘制文字提示
            ctx.fillStyle = "white";
            ctx.font = "20px Arial";
            ctx.fillText("这里是 AR 摄像头画面区域", 50, 50);

            // 如果有选中的素材，画在屏幕中间
            if (currentAsset.src && currentAsset.complete) {
                const size = 200;
                ctx.drawImage(currentAsset, 
                    (canvas.width - size) / 2, 
                    (canvas.height - size) / 2, 
                    size, size
                );
                ctx.fillText("当前选中的素材:", (canvas.width - size) / 2, (canvas.height - size) / 2 - 20);
            }
            requestAnimationFrame(drawLoop);
        }
        drawLoop();

        // --- 2. 核心逻辑：从后端获取 Bucket 图片 ---
        async function loadGallery() {
            const galleryContainer = document.getElementById('gallery-container');

            try {
                // 请求后端接口
                const response = await fetch('/api/images');
                const images = await response.json();

                // 清空“加载中”提示
                galleryContainer.innerHTML = '';

                if (images.error) {
                    throw new Error(images.error);
                }

                if (images.length === 0) {
                    galleryContainer.innerHTML = '<div id="loading-text">Bucket 里没有图片</div>';
                    return;
                }

                // 遍历图片并创建 DOM 元素
                images.forEach((imgData, index) => {
                    const imgEl = document.createElement('img');
                    imgEl.src = imgData.url;
                    imgEl.className = 'gallery-item';
                    imgEl.title = imgData.name;

                    // 点击事件
                    imgEl.onclick = () => {
                        console.log("切换素材为:", imgData.name);
                        
                        // A. 视觉反馈：处理边框高亮
                        document.querySelectorAll('.gallery-item').forEach(el => el.classList.remove('selected'));
                        imgEl.classList.add('selected');

                        // B. 逻辑反馈：更新 AR 用的图片对象
                        // 注意：这里要把 crossorigin 设为 anonymous，防止画布污染
                        currentAsset.crossOrigin = "Anonymous";
                        currentAsset.src = imgData.url;
                    };

                    // 默认选中第一张
                    if (index === 0) {
                        imgEl.click();
                    }

                    galleryContainer.appendChild(imgEl);
                });

            } catch (err) {
                console.error(err);
                galleryContainer.innerHTML = `<div id="loading-text" style="color:red">加载失败: ${err.message}</div>`;
            }
        }

        // 页面加载完毕后执行
        loadGallery();

    </script>
</body>
</html>