<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¢¦å¹»ç²’å­åœ£è¯æ ‘ AR</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        video { display: none; }
        canvas { position: absolute; width: 100%; height: 100%; transform: scaleX(-1); }
        #gallery-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0, 0, 0, 0.6); display: flex; align-items: center;
            overflow-x: auto; padding: 0 10px; box-sizing: border-box; z-index: 100;
        }
        .gallery-item {
            height: 80px; width: 80px; object-fit: cover; margin-right: 10px;
            border-radius: 8px; cursor: pointer; border: 3px solid transparent;
            transition: all 0.2s; flex-shrink: 0;
        }
        .gallery-item:hover { transform: scale(1.05); }
        .gallery-item.selected { border-color: #ffd700; }
        #loading-text { color: white; width: 100%; text-align: center; }
        #instruction {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%) scaleX(-1);
            color: gold; background: rgba(0,0,0,0.5); padding: 10px 20px;
            border-radius: 20px; pointer-events: none; z-index: 50; text-shadow: 0 0 10px gold;
        }
    </style>
</head>
<body>

    <div id="instruction">âœ¨ å•æ‰‹æåˆæ‹–åŠ¨ | ğŸ‘åŒæ‰‹æåˆç¼©æ”¾ âœ¨</div>

    <video id="input_video"></video>
    <canvas id="output_canvas"></canvas>

    <div id="gallery-container">
        <div id="loading-text">æ­£åœ¨åŠ è½½äº‘ç«¯ç²’å­ç´ æ...</div>
    </div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    // --- 1. çŠ¶æ€ç®¡ç† ---
    let imgObj = new Image(); imgObj.src = ""; 
    let imgState = { x: 0.5, y: 0.5, scale: 0.3, aspectRatio: 1 };
    function getDistance(p1, p2) { return Math.hypot(p1.x - p2.x, p1.y - p2.y); }

    // ==========================================
    // --- ğŸŒŸ æ ¸å¿ƒå‡çº§ï¼šç²’å­æ ‘ç³»ç»Ÿ ğŸŒŸ ---
    // ==========================================
    class Particle {
        constructor() {
            this.reset();
            this.y = Math.random(); // åˆå§‹é«˜åº¦éšæœº
        }
        reset() {
            this.y = 0; // ä»åº•éƒ¨å¼€å§‹
            this.angle = Math.random() * Math.PI * 2; // éšæœºè§’åº¦
            // é¢œè‰²åº“ï¼šå¤§é‡é‡‘è‰²ï¼Œå°‘é‡çº¢ç»¿ç‚¹ç¼€
            const colors = ['#FFD700', '#FFD700', '#FFD700', '#FF4500', '#ADFF2F', '#ffffff'];
            this.color = colors[Math.floor(Math.random() * colors.length)];
            this.speed = Math.random() * 0.002 + 0.001; // ä¸Šå‡é€Ÿåº¦
            this.radiusMod = Math.random() * 0.5 + 0.5; // å¤§å°éšæœºå¾®è°ƒ
            this.spinSpeed = Math.random() * 0.02 - 0.01; // æ—‹è½¬é€Ÿåº¦
        }
        update() {
            this.y += this.speed;
            this.angle += this.spinSpeed;
            if (this.y > 1) this.reset(); // è¶…è¿‡é¡¶éƒ¨é‡ç½®åˆ°åº•éƒ¨ï¼Œå½¢æˆå¾ªç¯
        }
    }

    class ParticleTree {
        constructor() {
            this.particles = [];
            for(let i = 0; i < 800; i++) { // 800ä¸ªç²’å­
                this.particles.push(new Particle());
            }
            this.starAngle = 0;
        }
        draw(ctx, centerX, centerY, baseScale) {
            const treeHeight = window.innerHeight * 0.6 * baseScale;
            const maxRadius = treeHeight * 0.4;

            ctx.save();
            // å…³é”®ï¼šå åŠ æ¨¡å¼å˜äº®ï¼Œåˆ¶é€ å‘å…‰æ„Ÿ
            ctx.globalCompositeOperation = 'lighter';
            
            this.particles.forEach(p => {
                p.update();
                // æ ¸å¿ƒç®—æ³•ï¼šéšç€é«˜åº¦(y)å¢åŠ ï¼ŒåŠå¾„(r)å˜å°ï¼Œå½¢æˆåœ†é”¥ä½“
                const currentRadius = maxRadius * (1 - p.y);
                // è®¡ç®—ç²’å­çš„ç»å¯¹åæ ‡
                const px = centerX + Math.cos(p.angle) * currentRadius;
                const py = centerY + (p.y - 0.5) * -treeHeight; // yè½´åè½¬ï¼Œ0.5ä¸ºä¸­å¿ƒç‚¹

                // ç»˜åˆ¶å‘å…‰ç²’å­
                const size = (3 * p.radiusMod) * baseScale;
                ctx.beginPath();
                ctx.arc(px, py, size, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                // å¼ºåŠ›å‘å…‰æ•ˆæœ
                ctx.shadowColor = p.color;
                ctx.shadowBlur = 15 * baseScale;
                ctx.fill();
            });

            // ç»˜åˆ¶é¡¶éƒ¨å¤§æ˜Ÿæ˜Ÿ
            this.starAngle += 0.02;
            ctx.translate(centerX, centerY - treeHeight * 0.55);
            ctx.rotate(this.starAngle);
            this.drawStar(ctx, 0, 0, 5, 15 * baseScale, 7 * baseScale);
            ctx.restore();
        }

        drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx; let y = cy;
            let step = Math.PI / spikes;

            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius; y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y); rot += step;
                x = cx + Math.cos(rot) * innerRadius; y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y); rot += step;
            }
            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();
            ctx.fillStyle = "#FFFACD";
            ctx.shadowColor = "#FFD700";
            ctx.shadowBlur = 30;
            ctx.fill();
        }
    }
    // åˆå§‹åŒ–ç²’å­æ ‘ç³»ç»Ÿ
    const myParticleTree = new ParticleTree();
    // ==========================================

    // --- 4. MediaPipe æ¯ä¸€å¸§çš„å›è°ƒ ---
    function onResults(results) {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
        
        canvasCtx.save();
        // A. ç»˜åˆ¶èƒŒæ™¯ (ç¨å¾®å˜æš—ä¸€ç‚¹ï¼Œçªå‡ºç²’å­)
        canvasCtx.filter = 'brightness(0.7)';
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.filter = 'none';
        
        // B. ğŸŒŸ ç»˜åˆ¶æ–°çš„ç²’å­æ ‘ ğŸŒŸ
        // ä½¿ç”¨ imgState çš„ä½ç½®å’Œç¼©æ”¾ï¼Œè®©ç²’å­æ ‘è·Ÿéšæ‰‹åŠ¿
        myParticleTree.draw(
            canvasCtx, 
            imgState.x * canvasElement.width, 
            imgState.y * canvasElement.height, 
            imgState.scale * 3 // æ”¾å¤§ä¸€ç‚¹åŸºç¡€æ¯”ä¾‹
        );

        // C. æ‰‹åŠ¿é€»è¾‘ (ä¿æŒä¸å˜)
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            let pinchHands = [];
            for (const landmarks of results.multiHandLandmarks) {
                const thumb = landmarks[4]; const index = landmarks[8];
                const distance = getDistance(thumb, index);
                if (distance < 0.05) {
                    const centerPoint = { x: (thumb.x + index.x)/2, y: (thumb.y + index.y)/2 };
                    // ç»˜åˆ¶æåˆæŒ‡ç¤ºå™¨
                    canvasCtx.beginPath();
                    canvasCtx.arc(centerPoint.x * canvasElement.width, centerPoint.y * canvasElement.height, 15, 0, 2 * Math.PI);
                    canvasCtx.strokeStyle = "gold"; canvasCtx.lineWidth = 3; canvasCtx.stroke();
                    pinchHands.push(centerPoint);
                }
            }
            if (pinchHands.length === 1) {
                imgState.x = pinchHands[0].x; imgState.y = pinchHands[0].y;
            } else if (pinchHands.length === 2) {
                const dist = getDistance(pinchHands[0], pinchHands[1]);
                imgState.scale = Math.max(0.1, dist * 2.5); 
                imgState.x = (pinchHands[0].x + pinchHands[1].x) / 2;
                imgState.y = (pinchHands[0].y + pinchHands[1].y) / 2;
            }
        }

        // D. ç»˜åˆ¶é€‰ä¸­çš„å›¾ç‰‡ (æŒ‚åœ¨æ ‘ä¸Šçš„ç…§ç‰‡)
        if(imgObj.src && imgObj.complete && imgObj.naturalWidth !== 0) {
            imgState.aspectRatio = imgObj.width / imgObj.height;
            const drawW = canvasElement.width * imgState.scale * 0.8; // å›¾ç‰‡ç¨å¾®æ¯”æ ‘å°ä¸€ç‚¹
            const drawH = drawW / imgState.aspectRatio;
            const drawX = imgState.x * canvasElement.width - drawW / 2;
            const drawY = imgState.y * canvasElement.height - drawH / 2;

            // ç»™ç…§ç‰‡ä¹ŸåŠ ä¸ªå‘å…‰é‡‘è¾¹æ¡†
            canvasCtx.save();
            canvasCtx.shadowColor = "gold";
            canvasCtx.shadowBlur = 15;
            canvasCtx.strokeStyle = "#FFD700";
            canvasCtx.lineWidth = 8;
            canvasCtx.strokeRect(drawX, drawY, drawW, drawH);
            canvasCtx.restore();

            canvasCtx.drawImage(imgObj, drawX, drawY, drawW, drawH);
        }
        
        canvasCtx.restore();
    }

    // --- 5. åˆå§‹åŒ–åŠåç»­é€»è¾‘ (ä¿æŒä¸å˜) ---
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);
    const camera = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 1280, height: 720 });
    camera.start();

    async function loadGallery() {
        const galleryContainer = document.getElementById('gallery-container');
        try {
            const res = await fetch('/api/images');
            const images = await res.json();
            galleryContainer.innerHTML = ''; 
            if (images.length === 0) { galleryContainer.innerHTML = '<div id="loading-text">æ²¡æœ‰å›¾ç‰‡</div>'; return; }
            images.forEach((imgData, index) => {
                const imgEl = document.createElement('img');
                imgEl.src = imgData.url; imgEl.className = 'gallery-item';
                imgEl.onclick = () => {
                    document.querySelectorAll('.gallery-item').forEach(e => e.classList.remove('selected'));
                    imgEl.classList.add('selected');
                    imgObj.crossOrigin = "Anonymous";
                    imgObj.src = imgData.url + "?t=" + new Date().getTime();
                };
                if (index === 0) imgEl.click();
                galleryContainer.appendChild(imgEl);
            });
        } catch (err) { console.error(err); galleryContainer.innerHTML = '<div id="loading-text">ç´ æåŠ è½½å¤±è´¥</div>'; }
    }
    loadGallery();
</script>
</body>
</html>