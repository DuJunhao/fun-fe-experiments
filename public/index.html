<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ£è¯æ ‘æ‰‹åŠ¿ AR (æœ€ç»ˆç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        
        /* æ‘„åƒå¤´ç”»é¢å’Œç”»å¸ƒé‡å  */
        video { display: none; }
        canvas { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ï¼Œç¬¦åˆé•œå­ç›´è§‰ */
        }

        /* åº•éƒ¨ç´ æåº“æ ·å¼ */
        #gallery-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 0 10px;
            box-sizing: border-box;
            z-index: 100;
        }

        .gallery-item {
            height: 80px;
            width: 80px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .gallery-item:hover { transform: scale(1.05); }
        .gallery-item.selected { border-color: #ffd700; }
        
        #loading-text { color: white; width: 100%; text-align: center; }
        
        /* ç®€å•çš„æ“ä½œæç¤º */
        #instruction {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) scaleX(-1); /* æ–‡å­—ä¸æƒ³è¢«é•œåƒç¿»è½¬ï¼Œæ‰€ä»¥ååè½¬ */
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 20px;
            pointer-events: none;
            z-index: 50;
        }
    </style>
</head>
<body>

    <div id="instruction">â˜ï¸å•æ‰‹æåˆæ‹–åŠ¨ | ğŸ‘åŒæ‰‹æåˆç¼©æ”¾</div>

    <video id="input_video"></video>
    <canvas id="output_canvas"></canvas>

    <div id="gallery-container">
        <div id="loading-text">æ­£åœ¨ä»äº‘ç«¯åŠ è½½ç´ æ...</div>
    </div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    // --- 1. å›¾ç‰‡çŠ¶æ€ç®¡ç† ---
    let imgObj = new Image();
    // é»˜è®¤ç©ºå›¾ï¼Œç­‰ç”¨æˆ·ç‚¹é€‰
    imgObj.src = ""; 
    
    let imgState = {
        x: 0.5, // å±å¹•ä¸­å¿ƒ (0-1)
        y: 0.5,
        scale: 0.3,
        aspectRatio: 1
    };

    // --- 2. æ ¸å¿ƒé€»è¾‘ï¼šè®¡ç®—è·ç¦» ---
    function getDistance(p1, p2) {
        return Math.hypot(p1.x - p2.x, p1.y - p2.y);
    }

    // --- 3. ç»˜åˆ¶åœ£è¯æ ‘å‡½æ•° ---
    function drawTree(ctx, width, height) {
        ctx.save();
        ctx.fillStyle = "#2E8B57"; // æ£®æ—ç»¿
        
        // æ ‘å†  (ä¸‰å±‚ä¸‰è§’å½¢)
        const levels = 3;
        const centerX = width * 0.5; // å±…ä¸­
        
        // ç®€å•çš„é˜´å½±æ•ˆæœ
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 10;

        for(let i=0; i<levels; i++) {
            ctx.beginPath();
            // è®¡ç®—æ¯ä¸€å±‚çš„ä½ç½®
            const yStart = height * 0.2 + (i * height * 0.15);
            const w = width * (0.15 + i * 0.1); // è¶Šå¾€ä¸‹è¶Šå®½
            
            ctx.moveTo(centerX, yStart);
            ctx.lineTo(centerX - w, yStart + height * 0.25);
            ctx.lineTo(centerX + w, yStart + height * 0.25);
            ctx.fill();
        }
        
        // æ ‘å¹²
        ctx.fillStyle = "#8B4513"; // æ£•è‰²
        ctx.fillRect(centerX - width*0.04, height * 0.75, width*0.08, height*0.15);
        
        // æ ‘é¡¶æ˜Ÿæ˜Ÿ
        ctx.fillStyle = "gold";
        ctx.beginPath();
        ctx.arc(centerX, height * 0.18, width * 0.03, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }

    // --- 4. MediaPipe æ¯ä¸€å¸§çš„å›è°ƒ ---
    function onResults(results) {
        // è®¾ç½®ç”»å¸ƒå°ºå¯¸é“ºæ»¡å…¨å±
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
        
        // A. ç»˜åˆ¶æ‘„åƒå¤´èƒŒæ™¯
        canvasCtx.save();
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        // B. ç»˜åˆ¶åœ£è¯æ ‘ (å›ºå®šåœ¨èƒŒæ™¯ä¸Š)
        drawTree(canvasCtx, canvasElement.width, canvasElement.height);

        // C. å¤„ç†æ‰‹åŠ¿é€»è¾‘
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            let pinchHands = [];

            for (const landmarks of results.multiHandLandmarks) {
                // ç»˜åˆ¶æ‰‹éƒ¨éª¨éª¼ (å¯é€‰ï¼Œæ–¹ä¾¿è°ƒè¯•)
                // drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 1});
                
                // å…³é”®ç‚¹ï¼š4(æ‹‡æŒ‡å°–), 8(é£ŸæŒ‡å°–)
                const thumb = landmarks[4];
                const index = landmarks[8];
                const distance = getDistance(thumb, index);

                // æåˆåˆ¤å®š (è·ç¦»å°äº 0.05 ç®—æåˆ)
                const isPinching = distance < 0.05;
                
                // è®¡ç®—ä¸¤æŒ‡ä¸­å¿ƒç‚¹
                const centerPoint = { x: (thumb.x + index.x)/2, y: (thumb.y + index.y)/2 };
                
                if (isPinching) {
                    // è§†è§‰åé¦ˆï¼šåœ¨æŒ‡å°–ç”»ä¸ªçº¢ç‚¹
                    canvasCtx.beginPath();
                    canvasCtx.arc(centerPoint.x * canvasElement.width, centerPoint.y * canvasElement.height, 10, 0, 2 * Math.PI);
                    canvasCtx.fillStyle = "rgba(255, 0, 0, 0.7)";
                    canvasCtx.fill();
                    pinchHands.push(centerPoint);
                }
            }

            // äº¤äº’é€»è¾‘
            if (pinchHands.length === 1) {
                // å•æ‰‹æåˆ -> ç§»åŠ¨å›¾ç‰‡
                imgState.x = pinchHands[0].x; 
                imgState.y = pinchHands[0].y;
            } else if (pinchHands.length === 2) {
                // åŒæ‰‹æåˆ -> ç¼©æ”¾å›¾ç‰‡
                const dist = getDistance(pinchHands[0], pinchHands[1]);
                // ç®€å•çš„ç¼©æ”¾æ˜ å°„
                imgState.scale = Math.max(0.1, dist * 2.5); 
                // ä½ç½®è®¾ä¸ºä¸¤æ‰‹ä¸­å¿ƒ
                imgState.x = (pinchHands[0].x + pinchHands[1].x) / 2;
                imgState.y = (pinchHands[0].y + pinchHands[1].y) / 2;
            }
        }

        // D. ç»˜åˆ¶é€‰ä¸­çš„å›¾ç‰‡ (å¦‚æœæœ‰)
        // å¢åŠ  naturalWidth æ£€æŸ¥ï¼Œé˜²æ­¢ CORS å¤±è´¥çš„å›¾ç‰‡å¯¼è‡´æŠ¥é”™
        if(imgObj.src && imgObj.complete && imgObj.naturalWidth !== 0) {
            if (imgObj.width && imgObj.height) {
                imgState.aspectRatio = imgObj.width / imgObj.height;
            }
            
            const drawW = canvasElement.width * imgState.scale;
            const drawH = drawW / imgState.aspectRatio;
            
            // åæ ‡ä¸­å¿ƒå¯¹é½
            const drawX = imgState.x * canvasElement.width - drawW / 2;
            const drawY = imgState.y * canvasElement.height - drawH / 2;

            canvasCtx.drawImage(imgObj, drawX, drawY, drawW, drawH);
            
            // åŠ ä¸ªé‡‘è‰²ç›¸æ¡†
            canvasCtx.strokeStyle = "gold";
            canvasCtx.lineWidth = 5;
            canvasCtx.strokeRect(drawX, drawY, drawW, drawH);
        }
        
        canvasCtx.restore();
    }

    // --- 5. åˆå§‹åŒ– MediaPipe Hands ---
    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(onResults);

    // å¯åŠ¨æ‘„åƒå¤´
    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 1280,
        height: 720
    });
    camera.start();

    // --- 6. åŠ è½½äº‘ç«¯ç´ æåº“ (å¸¦é˜²ç¼“å­˜ä¿®å¤) ---
    async function loadGallery() {
        const galleryContainer = document.getElementById('gallery-container');
        try {
            // è¯·æ±‚ Node.js æ¥å£è·å–å›¾ç‰‡åˆ—è¡¨
            const res = await fetch('/api/images');
            const images = await res.json();
            
            galleryContainer.innerHTML = ''; // æ¸…ç©º loading

            if (images.length === 0) {
                galleryContainer.innerHTML = '<div id="loading-text">æ²¡æœ‰å›¾ç‰‡</div>';
                return;
            }

            images.forEach((imgData, index) => {
                const imgEl = document.createElement('img');
                // ç¼©ç•¥å›¾å¯ä»¥ç›´æ¥ç”¨
                imgEl.src = imgData.url;
                imgEl.className = 'gallery-item';
                
                imgEl.onclick = () => {
                    console.log("åˆ‡æ¢ç´ æ:", imgData.name);
                    document.querySelectorAll('.gallery-item').forEach(e => e.classList.remove('selected'));
                    imgEl.classList.add('selected');

                    // âš¡ï¸ æ ¸å¿ƒä¿®å¤ï¼š
                    // 1. è®¾ç½® crossOrigin ç”³è¯·è·¨åŸŸ
                    // 2. åŠ æ—¶é—´æˆ³å‚æ•° ?t=xxx ç»•è¿‡æµè§ˆå™¨ç¼“å­˜ï¼Œå¼ºåˆ¶è¯·æ±‚å¸¦ CORS å¤´çš„å›¾ç‰‡
                    imgObj.crossOrigin = "Anonymous";
                    imgObj.src = imgData.url + "?t=" + new Date().getTime();
                };

                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€å¼ 
                if (index === 0) imgEl.click();
                galleryContainer.appendChild(imgEl);
            });

        } catch (err) {
            console.error(err);
            galleryContainer.innerHTML = '<div id="loading-text">ç´ æåŠ è½½å¤±è´¥</div>';
        }
    }

    loadGallery();

</script>

</body>
</html>